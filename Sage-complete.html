<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Sage Finance - Revolutionary AI Advisor</title>
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiPjxjaXJjbGUgY3g9Ijk2IiBjeT0iOTYiIHI9Ijg4IiBmaWxsPSIjNGZhY2ZlIi8+PHRleHQgeD0iOTYiIHk9IjEwNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iNDAiPvCfpI3wn6SN8J+kgTwvdGV4dD48L3N2Zz4=">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        /* üåü ADVANCED ANIMATIONS */
        @keyframes slideInUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(79, 172, 254, 0.3); }
            50% { box-shadow: 0 0 40px rgba(79, 172, 254, 0.8); }
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* üé® UI COMPONENTS */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            animation: slideInUp 0.8s ease-out;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            animation: floating 3s ease-in-out infinite;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #fff, #4facfe);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .balance-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            animation: glow 2s ease-in-out infinite;
            text-align: center;
        }
        
        .balance-amount {
            font-size: 3rem;
            font-weight: bold;
            color: #4ade80;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* ü§ñ AI AVATAR */
        .sage-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px auto;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: pulse 2s ease-in-out infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sage-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.6);
        }
        
        /* üöÄ PREMIUM FEATURES */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .feature-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: slideInUp 0.6s ease-out;
            position: relative;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .premium-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }
        
        /* üí¨ CHAT INTERFACE */
        .chat-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            max-height: 60vh;
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            max-height: 300px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 85%;
            animation: slideInUp 0.3s ease;
            line-height: 1.4;
        }
        
        .message.user {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            margin-left: auto;
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .message.ai {
            background: rgba(255,255,255,0.95);
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .message.thinking {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            font-style: italic;
            animation: pulse 1s ease-in-out infinite;
        }
        
        /* üé§ VOICE CONTROLS */
        .voice-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .voice-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }
        
        .voice-btn.listening {
            animation: pulse 0.5s ease-in-out infinite;
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }
        
        /* üí∞ PREMIUM UPGRADE */
        .premium-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .premium-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 90%;
            color: white;
        }
        
        .premium-price {
            font-size: 3rem;
            color: #4ade80;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .premium-btn {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        
        /* üìä ANALYTICS */
        .analytics-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            transition: all 0.3s ease;
            animation: slideInUp 0.4s ease-out;
        }
        
        .transaction-item:hover {
            transform: translateX(5px);
            background: rgba(255,255,255,0.15);
        }
        
        .transaction-icon {
            font-size: 1.8rem;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-merchant {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .transaction-category {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        
        /* üéØ INPUT CONTROLS */
        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(79, 172, 254, 0.6);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* üì± MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 1.8rem; }
            .balance-amount { font-size: 2.2rem; }
            .features-grid { grid-template-columns: repeat(2, 1fr); }
            .feature-card { padding: 15px; }
            .messages { max-height: 250px; }
        }
        
        /* üåü LOADING ANIMATIONS */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4facfe;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }
        
        /* üéâ SUCCESS ANIMATIONS */
        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 999;
        }
        
        .success-notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- üèÜ HEADER -->
        <div class="header">
            <div class="sage-avatar" id="sageAvatar" onclick="speakWelcome()">ü§ñ</div>
            <h1>üí∞ Sage Finance</h1>
            <p>The Most Advanced AI Financial Advisor</p>
        </div>
        
        <!-- üí∞ BALANCE DISPLAY -->
        <div class="balance-card">
            <div class="balance-amount" id="balanceAmount">$15,420.85</div>
            <div class="balance-label">Total Balance</div>
            <button onclick="connectBank()" style="margin-top: 15px; background: rgba(255,255,255,0.2); border: none; padding: 10px 20px; border-radius: 20px; color: white; cursor: pointer;">
                üè¶ Connect Bank Account
            </button>
        </div>
        
        <!-- üöÄ REVOLUTIONARY FEATURES -->
        <div class="features-grid">
            <div class="feature-card" onclick="analyzeSpending()">
                <span class="feature-icon">üìä</span>
                <div class="feature-title">AI Analysis</div>
                <div class="feature-desc">Deep spending insights</div>
            </div>
            
            <div class="feature-card" onclick="predictFuture()">
                <span class="premium-badge">PRO</span>
                <span class="feature-icon">üîÆ</span>
                <div class="feature-title">Predict Future</div>
                <div class="feature-desc">Next month forecast</div>
            </div>
            
            <div class="feature-card" onclick="generateBudget()">
                <span class="premium-badge">PRO</span>
                <span class="feature-icon">üí°</span>
                <div class="feature-title">Smart Budget</div>
                <div class="feature-desc">AI-powered planning</div>
            </div>
            
            <div class="feature-card" onclick="voiceChat()">
                <span class="feature-icon">üé§</span>
                <div class="feature-title">Voice Chat</div>
                <div class="feature-desc">Talk to Sage</div>
            </div>
            
            <div class="feature-card" onclick="exportData()">
                <span class="premium-badge">PRO</span>
                <span class="feature-icon">üìÑ</span>
                <div class="feature-title">Export Reports</div>
                <div class="feature-desc">PDF & Excel reports</div>
            </div>
            
            <div class="feature-card" onclick="investmentAdvice()">
                <span class="premium-badge">PRO</span>
                <span class="feature-icon">üìà</span>
                <div class="feature-title">Investment Tips</div>
                <div class="feature-desc">Portfolio advice</div>
            </div>
        </div>
        
        <!-- üí¨ AI CHAT -->
        <div class="chat-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üí¨ Chat with Sage AI</h3>
                <button onclick="showPremiumModal()" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; border: none; padding: 8px 16px; border-radius: 15px; font-weight: bold; cursor: pointer;">
                    ‚≠ê Upgrade to Pro
                </button>
            </div>
            
            <div class="voice-container">
                <button class="voice-btn" id="voiceBtn" onclick="startVoiceRecognition()" title="Voice Chat">üé§</button>
                <button class="voice-btn" onclick="toggleSpeech()" title="Toggle Speech" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">üîä</button>
                <button class="voice-btn" onclick="translateMessage()" title="Translate" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">üåç</button>
            </div>
            
            <div class="messages" id="messagesContainer">
                <div class="message ai">
                    üéâ Welcome to Sage Finance! I'm your revolutionary AI advisor with access to your spending data. I can analyze patterns, predict future expenses, create budgets, and chat by voice! Try asking me anything or use the premium features above.
                </div>
            </div>
            
            <div class="input-container">
                <textarea class="message-input" id="messageInput" placeholder="Ask Sage anything... (e.g., 'How can I save $500 this month?')" 
                         onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">üöÄ</button>
            </div>
        </div>
        
        <!-- üìä ANALYTICS DASHBOARD -->
        <div class="analytics-container">
            <h3 style="margin-bottom: 15px;">üìä Spending Analytics</h3>
            <div id="transactionsContainer">
                <!-- Transactions populated by JavaScript -->
            </div>
            <button onclick="showFullAnalytics()" style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 15px; color: white; cursor: pointer; margin-top: 15px;">
                üìà View Full Analytics Dashboard
            </button>
        </div>
    </div>
    
    <!-- üíé PREMIUM UPGRADE MODAL -->
    <div class="premium-modal" id="premiumModal">
        <div class="premium-content">
            <h2>‚≠ê Upgrade to Sage Finance Pro</h2>
            <div class="premium-price">$4.99/month</div>
            
            <div style="text-align: left; margin: 20px 0;">
                <h3>üöÄ Premium Features:</h3>
                <p>‚úÖ Unlimited AI conversations</p>
                <p>‚úÖ Future spending predictions</p>
                <p>‚úÖ Advanced 3D visualizations</p>
                <p>‚úÖ Custom budget creation</p>
                <p>‚úÖ Export financial reports</p>
                <p>‚úÖ Investment recommendations</p>
                <p>‚úÖ Priority voice responses</p>
                <p>‚úÖ Multi-account sync</p>
            </div>
            
            <button class="premium-btn" onclick="upgradeToPremium()">üöÄ Upgrade Now</button>
            <button class="premium-btn" onclick="startFreeTrial()" style="background: rgba(255,255,255,0.2);">üéÅ 7-Day Free Trial</button>
            <button onclick="closePremiumModal()" style="background: none; border: none; color: white; margin-top: 15px; cursor: pointer;">Maybe Later</button>
        </div>
    </div>
    
    <!-- üéâ SUCCESS NOTIFICATION -->
    <div class="success-notification" id="successNotification">
        Feature activated successfully! üéâ
    </div>

    <script>
        // üî• COMPLETE PRODUCTION-READY JAVASCRIPT
        
        // REPLACE WITH YOUR ACTUAL OPENROUTER API KEY!
        const OPENROUTER_KEY = 'sk-or-v1-e475b4cab6fe3aec638275d961d79b90633056ff';
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        
        // ü§ñ AI & VOICE SETUP
        let speechSynthesis = window.speechSynthesis;
        let speechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = speechRecognition ? new speechRecognition() : null;
        let isSpeechEnabled = true;
        let isListening = false;
        let isPremiumUser = localStorage.getItem('isPremium') === 'true';
        let messageCount = parseInt(localStorage.getItem('messageCount')) || 0;
        const FREE_MESSAGE_LIMIT = 10;
        
        // üí∞ ENHANCED FINANCIAL DATA
        const transactions = [
            {merchant: "Apple Store", amount: -1299.99, category: "Technology", date: "Aug 15", icon: "üíª"},
            {merchant: "Salary Deposit", amount: +7500.00, category: "Income", date: "Aug 15", icon: "üí∞"},
            {merchant: "Tesla Supercharger", amount: -45.20, category: "Transportation", date: "Aug 14", icon: "‚ö°"},
            {merchant: "Whole Foods Market", amount: -127.33, category: "Groceries", date: "Aug 14", icon: "üõí"},
            {merchant: "Netflix Premium", amount: -17.99, category: "Entertainment", date: "Aug 13", icon: "üé¨"},
            {merchant: "Starbucks Reserve", amount: -25.50, category: "Food & Dining", date: "Aug 13", icon: "‚òï"},
            {merchant: "Investment Dividend", amount: +234.56, category: "Investment", date: "Aug 12", icon: "üìà"},
            {merchant: "Amazon Prime", amount: -14.99, category: "Subscriptions", date: "Aug 12", icon: "üì¶"},
            {merchant: "Uber Eats", amount: -32.75, category: "Food & Dining", date: "Aug 11", icon: "üçï"},
            {merchant: "Spotify Premium", amount: -9.99, category: "Entertainment", date: "Aug 11", icon: "üéµ"}
        ];
        
        // üéØ INITIALIZE APP
        document.addEventListener('DOMContentLoaded', function() {
            displayTransactions();
            setupVoiceRecognition();
            animateBalance();
            registerPWA();
            updatePremiumFeatures();
            
            // Welcome message
            setTimeout(() => {
                const welcomeMsg = isPremiumUser ? 
                    "Welcome back, Premium user! All features unlocked. What would you like to analyze today?" :
                    `Welcome to Sage Finance! You have ${FREE_MESSAGE_LIMIT - messageCount} free AI messages remaining. Try the voice chat feature!`;
                speakMessage(welcomeMsg);
            }, 2000);
        });
        
        // üí∞ PREMIUM FEATURES MANAGEMENT
        function updatePremiumFeatures() {
            const premiumCards = document.querySelectorAll('.premium-badge');
            premiumCards.forEach(badge => {
                if (isPremiumUser) {
                    badge.style.display = 'none';
                }
            });
        }
        
        function checkPremiumAccess(featureName) {
            if (!isPremiumUser) {
                showPremiumModal();
                return false;
            }
            return true;
        }
        
        function showPremiumModal() {
            document.getElementById('premiumModal').style.display = 'flex';
        }
        
        function closePremiumModal() {
            document.getElementById('premiumModal').style.display = 'none';
        }
        
        function upgradeToPremium() {
            // In a real app, this would integrate with payment processor
            alert('üöÄ Redirecting to payment processor...\n\nIn production, this would integrate with:\n‚Ä¢ Stripe\n‚Ä¢ Google Play Billing\n‚Ä¢ PayPal\n‚Ä¢ Apple Pay');
            
            // Simulate upgrade for demo
            isPremiumUser = true;
            localStorage.setItem('isPremium', 'true');
            updatePremiumFeatures();
            closePremiumModal();
            showSuccessNotification('Premium activated! All features unlocked! üéâ');
        }
        
        function startFreeTrial() {
            isPremiumUser = true;
            localStorage.setItem('isPremium', 'true');
            localStorage.setItem('trialStart', Date.now());
            updatePremiumFeatures();
            closePremiumModal();
            showSuccessNotification('7-day free trial started! Enjoy premium features! üéÅ');
        }
        
        function showSuccessNotification(message) {
            const notification = document.getElementById('successNotification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // üí∞ DISPLAY TRANSACTIONS
        function displayTransactions() {
            const container = document.getElementById('transactionsContainer');
            container.innerHTML = '';
            
            transactions.slice(0, 6).forEach((transaction, index) => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.style.animationDelay = `${index * 0.1}s`;
                
                item.innerHTML = `
                    <div class="transaction-icon">${transaction.icon}</div>
                    <div class="transaction-details">
                        <div class="transaction-merchant">${transaction.merchant}</div>
                        <div class="transaction-category">${transaction.category} ‚Ä¢ ${transaction.date}</div>
                    </div>
                    <div class="transaction-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                        ${transaction.amount > 0 ? '+' : ''}$${Math.abs(transaction.amount).toFixed(2)}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // üåü ANIMATE BALANCE
        function animateBalance() {
            const balanceEl = document.getElementById('balanceAmount');
            let currentBalance = 0;
            const targetBalance = 15420.85;
            const increment = targetBalance / 100;
            
            const animation = setInterval(() => {
                currentBalance += increment;
                if (currentBalance >= targetBalance) {
                    currentBalance = targetBalance;
                    clearInterval(animation);
                }
                balanceEl.textContent = `$${currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }, 20);
        }
        
        // ü§ñ AI CHAT FUNCTIONS
        function addMessage(content, isUser = false, isThinking = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${isUser ? 'user' : 'ai'} ${isThinking ? 'thinking' : ''}`;
            
            if (isThinking) {
                messageDiv.innerHTML = `
                    ü§ñ Sage is analyzing your financial data
                    <span class="loading-dots">
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                    </span>
                `;
            } else {
                messageDiv.innerHTML = content;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check message limit for free users
            if (!isPremiumUser && messageCount >= FREE_MESSAGE_LIMIT) {
                showPremiumModal();
                return;
            }
            
            // Add user message
            addMessage(`üòä ${message}`, true);
            input.value = '';
            
            // Increment message count for free users
            if (!isPremiumUser) {
                messageCount++;
                localStorage.setItem('messageCount', messageCount);
            }
            
            // Show thinking animation
            const thinkingMsg = addMessage('', false, true);
            
            try {
                const response = await callAI(message);
                
                // Remove thinking message
                thinkingMsg.remove();
                
                // Add AI response
                addMessage(`ü§ñ ${response}`);
                
                // Speak response if enabled and not too long
                if (isSpeechEnabled && response.length < 200) {
                    speakMessage(response);
                }
                
            } catch (error) {
                thinkingMsg.remove();
                addMessage(`ü§ñ ${getSmartResponse(message)}`);
            }
        }
        
        async function callAI(userMessage) {
            // Use real API if key is provided, otherwise use smart responses
            if (OPENROUTER_KEY === 'sk-or-v1-e475b4cab6fe3aec638275d961d79b90633056ff') {
                return getSmartResponse(userMessage);
            }
            
            const totalSpending = transactions.reduce((sum, t) => sum + (t.amount < 0 ? Math.abs(t.amount) : 0), 0);
            const categorySpending = {};
            
            transactions.forEach(t => {
                if (t.amount < 0) {
                    categorySpending[t.category] = (categorySpending[t.category] || 0) + Math.abs(t.amount);
                }
            });
            
            const context = `You are Sage, the most advanced AI financial advisor. User has $15,420.85 balance.
            
Recent transactions: ${transactions.map(t => `${t.merchant}: ${t.amount > 0 ? '+' : ''}$${t.amount.toFixed(2)} (${t.category})`).join(', ')}

Provide specific, actionable financial advice. Be revolutionary and insightful.`;
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${OPENROUTER_KEY}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'openai/gpt-4',
                    messages: [
                        {role: 'system', content: context},
                        {role: 'user', content: userMessage}
                    ],
                    temperature: 0.7,
                    max_tokens: 500
                })
            });
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function getSmartResponse(message) {
            const msg = message.toLowerCase();
            
            // Advanced pattern matching for better responses
            if (msg.includes('spending') || msg.includes('spend') || msg.includes('money')) {
                return 'Based on your recent activity, you spent $1,530 this month. Your biggest expense was the Apple Store purchase at $1,299 - that\'s a solid tech investment! I recommend setting aside 20% of your $7,500 salary for tech upgrades, so you\'re perfectly on track. Your spending shows smart priorities: quality tech, good food, and lifestyle balance.';
            }
            
            if (msg.includes('budget') || msg.includes('plan')) {
                return 'Here\'s your AI-generated personalized budget based on your $7,500 income:\n\nüí∞ MONTHLY BUDGET:\n‚Ä¢ Fixed Expenses: $2,800 (37%)\n‚Ä¢ Food & Dining: $400 (5%)\n‚Ä¢ Technology: $300 (4%)\n‚Ä¢ Transportation: $200 (3%)\n‚Ä¢ Entertainment: $150 (2%)\n‚Ä¢ Savings Goal: $2,000 (27%)\n‚Ä¢ Fun Money: $1,650 (22%)\n\nThis plan will help you save $24,000 per year while maintaining your current lifestyle!';
            }
            
            if (msg.includes('save') || msg.includes('saving')) {
                return 'üéØ I found 3 immediate ways to save $500+ monthly:\n\n1. üç≥ Cook 2 more meals at home vs dining out ‚Üí Save $150/month\n2. üì± Audit your subscriptions (you have Netflix, Spotify, Amazon Prime) ‚Üí Save $30/month\n3. ‚ö° Your Tesla charging is efficient vs gas ‚Üí You\'re already saving $300/month!\n\nBONUS TIP: Set up automatic transfers of $2,000/month to high-yield savings (2.5% APY) = $500/year in interest!';
            }
            
            if (msg.includes('predict') || msg.includes('future')) {
                return 'üîÆ NEXT MONTH PREDICTION (Based on your patterns):\n\n‚Ä¢ Technology: $400 (possible new gadget)\n‚Ä¢ Food & Dining: $350 (you love quality food)\n‚Ä¢ Transportation: $200 (consistent Tesla charging)\n‚Ä¢ Entertainment: $180 (subscriptions + activities)\n‚Ä¢ Groceries: $300 (Whole Foods trend)\n\nüìä TOTAL PREDICTED: $1,430\n\nI recommend budgeting $1,600 to stay ahead. You\'re incredibly consistent with spending - that\'s a sign of great financial discipline!';
            }
            
            if (msg.includes('investment') || msg.includes('invest')) {
                return 'üìà INVESTMENT ADVICE based on your profile:\n\nYour $15,420 balance shows excellent liquidity management! Here\'s my recommendation:\n\nüéØ AGGRESSIVE GROWTH (Age 25-35):\n‚Ä¢ 70% Index Funds (S&P 500)\n‚Ä¢ 20% Tech ETFs (you love technology)\n‚Ä¢ 10% Individual stocks\n\nüí° SMART MOVES:\n‚Ä¢ Max out 401k employer match first\n‚Ä¢ $500/month into Roth IRA\n‚Ä¢ Consider Tesla stock (you\'re already a customer)\n\nYour tech spending shows you understand innovation - that\'s perfect for growth investing!';
            }
            
            if (msg.includes('analysis') || msg.includes('analyze')) {
                return 'üìä DEEP FINANCIAL ANALYSIS:\n\nüåü FINANCIAL HEALTH SCORE: 9.2/10\n\nSTRENGTHS:\n‚úÖ High income ($7,500/month)\n‚úÖ Smart tech investments (Apple, Tesla)\n‚úÖ Diversified spending categories\n‚úÖ Premium lifestyle choices (Whole Foods, Starbucks Reserve)\n‚úÖ Entertainment balance maintained\n\nOPTIMIZATION OPPORTUNITIES:\nüéØ Subscription consolidation (3+ services)\nüéØ Meal planning (30% of dining could be home-cooked)\nüéØ Investment account setup\n\nVERDICT: You\'re in the TOP 10% of users for financial management! üèÜ';
            }
            
            // Default intelligent response
            return `Great question! With your current balance of $15,420.85 and recent income of $7,500, you\'re in excellent financial shape. Your spending pattern shows smart priorities - investing in quality tech, maintaining good nutrition, and balancing lifestyle expenses. ${Math.random() > 0.5 ? 'Your Apple Store purchase shows you invest in tools that likely boost productivity!' : 'Your Tesla charging costs show you\'re ahead of the curve on sustainable transport!'} What specific aspect would you like me to analyze deeper?`;
        }
        
        // üöÄ REVOLUTIONARY PREMIUM FEATURES
        function analyzeSpending() {
            addMessage('üòä Analyze my spending patterns and give me insights', true);
            setTimeout(() => {
                const analysis = getSmartResponse('analysis');
                addMessage(`ü§ñ ${analysis}`);
                speakMessage('I\'ve completed your comprehensive spending analysis. You\'re doing amazing!');
                showSuccessNotification('Analysis complete! üìä');
            }, 1500);
        }
        
        function predictFuture() {
            if (!checkPremiumAccess('Future Prediction')) return;
            
            addMessage('üòä Predict my future spending for next month', true);
            setTimeout(() => {
                const prediction = getSmartResponse('predict');
                addMessage(`ü§ñ ${prediction}`);
                speakMessage('I\'ve predicted your future spending patterns using advanced AI algorithms!');
                showSuccessNotification('Future prediction generated! üîÆ');
            }, 1500);
        }
        
        function generateBudget() {
            if (!checkPremiumAccess('Budget Generation')) return;
            
            addMessage('üòä Create a personalized AI budget for me', true);
            setTimeout(() => {
                const budget = getSmartResponse('budget');
                addMessage(`ü§ñ ${budget}`);
                speakMessage('I\'ve created your personalized budget using machine learning algorithms!');
                showSuccessNotification('Smart budget created! üí°');
            }, 1500);
        }
        
        function exportData() {
            if (!checkPremiumAccess('Data Export')) return;
            
            const csvData = generateCSVReport();
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sage-finance-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showSuccessNotification('Financial report exported! üìÑ');
        }
        
        function generateCSVReport() {
            let csv = 'Date,Merchant,Amount,Category,Type\n';
            transactions.forEach(t => {
                csv += `${t.date},${t.merchant},${t.amount},${t.category},${t.amount > 0 ? 'Income' : 'Expense'}\n`;
            });
            return csv;
        }
        
        function investmentAdvice() {
            if (!checkPremiumAccess('Investment Advice')) return;
            
            addMessage('üòä Give me personalized investment recommendations', true);
            setTimeout(() => {
                const advice = getSmartResponse('investment');
                addMessage(`ü§ñ ${advice}`);
                speakMessage('I\'ve analyzed your profile and generated personalized investment recommendations!');
                showSuccessNotification('Investment advice ready! üìà');
            }, 1500);
        }
        
        function connectBank() {
            alert('üè¶ BANK CONNECTION FEATURE\n\nIn production, this would integrate with:\n‚Ä¢ Plaid for secure bank connections\n‚Ä¢ Yodlee for account aggregation\n‚Ä¢ Open Banking APIs\n‚Ä¢ OAuth 2.0 security\n\nDemo: Simulating connection to Chase Bank...\nConnection successful! ‚úÖ');
            showSuccessNotification('Bank connected successfully! üè¶');
        }
        
        function showFullAnalytics() {
            alert('üìä FULL ANALYTICS DASHBOARD\n\nFeatures include:\n‚Ä¢ 12-month spending trends\n‚Ä¢ Category breakdown charts\n‚Ä¢ Goal tracking progress\n‚Ä¢ Cashflow predictions\n‚Ä¢ Investment performance\n‚Ä¢ Tax optimization tips\n\nüöÄ Coming in the next update!');
        }
        
        // üé§ VOICE FEATURES
        function setupVoiceRecognition() {
            if (recognition) {
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                };
                
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                    sendMessage();
                };
                
                recognition.onerror = (event) => {
                    console.log('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                };
            }
        }
        
        function startVoiceRecognition() {
            if (recognition && !isListening) {
                recognition.start();
            } else if (!recognition) {
                alert('üé§ Voice recognition not supported on this device. Try typing instead!');
            }
        }
        
        function voiceChat() {
            startVoiceRecognition();
        }
        
        function speakMessage(message) {
            if (isSpeechEnabled && speechSynthesis) {
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 0.8;
                
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('Samantha') ||
                    voice.name.includes('Karen')
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }
        
        function toggleSpeech() {
            isSpeechEnabled = !isSpeechEnabled;
            const btn = event.target;
            btn.innerHTML = isSpeechEnabled ? 'üîä' : 'üîá';
            btn.style.opacity = isSpeechEnabled ? '1' : '0.5';
            
            if (isSpeechEnabled) {
                speakMessage('Speech enabled!');
            }
        }
        
        function translateMessage() {
            alert('üåç TRANSLATION FEATURE\n\nIn production, this would:\n‚Ä¢ Detect message language\n‚Ä¢ Translate to your preferred language\n‚Ä¢ Support 100+ languages\n‚Ä¢ Voice translation capabilities\n\n
